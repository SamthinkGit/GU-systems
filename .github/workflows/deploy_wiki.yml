name: Deploy Wiki to Pages

# Activar en cambios de la wiki
on:
  gollum: {} # Evento para ediciones de la wiki&#8203;:contentReference[oaicite:7]{index=7}
  # Puedes añadir triggers manuales o programados si lo deseas:
  # push:
  #   branches: [ main ]
  #   paths: [ "mkdocs.yml" ]  # por ejemplo, para re-deploy cuando cambia la config
  # workflow_dispatch: {}      # permite ejecutarlo manualmente desde la pestaña Actions

permissions:
  contents: write # Necesario para poder hacer push a Pages (gh-pages branch)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # Paso 1: Checkout del repositorio principal (para acceder a mkdocs.yml y quizás otros archivos necesarios)
      - name: Checkout repo
        uses: actions/checkout@v3

      # Paso 2: Checkout del repositorio de la Wiki en carpeta "wiki"
      - name: Checkout wiki content
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}.wiki # Clona el repositorio "<user>/<repo>.wiki"
          ref: main # rama por defecto de la wiki (a veces 'master' o 'main')
          path: wiki # lo coloca en subcarpeta "wiki"

      # Paso 3: Convertir sintaxis de enlaces de la wiki a enlaces Markdown estándar (si es necesario)
      - name: Fix wiki links
        run: |
          # Reemplaza [[Page]] por [Page](Page.md) y [[Page|Texto]] por [Texto](Page.md)
          sed -i 's/\[\[\([^|]*\)\]\]/[\1](\1.md)/g' wiki/*.md
          sed -i 's/\[\[\([^|]*\)|\([^]]*\)\]\]/[\2](\1.md)/g' wiki/*.md

      # Paso 4: Asegurar página de inicio para MkDocs
      - name: Prepare index page
        run: |
          if [ -f "wiki/Home.md" ]; then
            cp wiki/Home.md wiki/index.md
          elif [ ! -f "wiki/index.md" ]; then
            # Si no hay Home.md, crear un índice básico listando páginas
            echo "# Documentation" > wiki/index.md
            echo -e "\n*Welcome to the ECM docs.*\n" >> wiki/index.md
            for FILE in wiki/*.md; do
              NAME=$(basename "$FILE")
              [[ "$NAME" == "index.md" ]] && continue
              TITLE="${NAME%.md}"
              # Reemplazar guiones por espacios para título
              TITLE="${TITLE//-/ }"
              echo "- [${TITLE}](${NAME})" >> wiki/index.md
            done
          fi

      # Paso 5: Instalar MkDocs (y tema Material si se desea)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - name: Install MkDocs
        run: |
          pip install mkdocs
          pip install mkdocs-material  # opcional: instala tema Material

      # Paso 6: Construir el sitio estático con MkDocs
      - name: Build site
        run: mkdocs build # Generará el sitio en la carpeta "site/"


      # Paso 7: Desplegar a GitHub Pages (rama gh-pages)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
